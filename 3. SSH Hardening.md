### Server Audit

I used ssh-audit.com by Positron Security with the _“Hardened Ubuntu Server 24.04 LTS (version 1)”_ policy to audit the SSH configuration:

[https://ssh-audit.com](https://ssh-audit.com)

The initial audit failed due to policy violations related to host keys, key exchanges, ciphers, and MACs. To resolve this, I followed their official Ubuntu 24.04 LTS hardening guide:

[https://www.sshaudit.com/hardening_guides.html#ubuntu_24_04_lts](https://www.sshaudit.com/hardening_guides.html#ubuntu_24_04_lts)

---
### Hardening Steps

#### 1. Regenerate ED25519 and RSA Host Keys

```
rm /etc/ssh/ssh_host_* ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N "" ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""
```

---
#### 2. Remove Weak Diffie-Hellman Moduli

```
awk '$5 >= 3071' /etc/ssh/moduli > /etc/ssh/moduli.safe mv /etc/ssh/moduli.safe /etc/ssh/moduli
```

---
#### 3. Restrict Supported Key Exchange, Cipher, and MAC Algorithms

```
echo -e "# Restrict key exchange, cipher, and MAC algorithms, as per sshaudit.com # hardening guide. KexAlgorithms sntrup761x25519-sha512@openssh.com,gss-curve25519-sha256-,curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha256,gss-group16-sha512-,diffie-hellman-group16-sha512  Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-gcm@openssh.com,aes128-ctr  MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com  RequiredRSASize 3072  HostKeyAlgorithms sk-ssh-ed25519-cert-v01@openssh.com,ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,ssh-ed25519,rsa-sha2-512,rsa-sha2-256  CASignatureAlgorithms sk-ssh-ed25519@openssh.com,ssh-ed25519,rsa-sha2-512,rsa-sha2-256  GSSAPIKexAlgorithms gss-curve25519-sha256-,gss-group16-sha512-  HostbasedAcceptedAlgorithms sk-ssh-ed25519-cert-v01@openssh.com,ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,ssh-ed25519,rsa-sha2-512,rsa-sha2-256  PubkeyAcceptedAlgorithms sk-ssh-ed25519-cert-v01@openssh.com,ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,ssh-ed25519,rsa-sha2-512,rsa-sha2-256" > /etc/ssh/sshd_config.d/ssh-audit_hardening.conf
```

---
#### 4. Restart OpenSSH

```
service ssh restart
```

---
### Connection Rate Throttling

To mitigate the [DHEat denial-of-service attack](https://www.positronsecurity.com/blog/2024-04-23-an-analysis-of-dheat-dos-against-ssh-in-cloud-environments/), I implemented connection rate throttling. This configuration allows up to 10 new SSH connections per IP every 10 seconds.

```
iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 10 --hitcount 10 -j DROP  ip6tables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set ip6tables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 10 --hitcount 10 -j DROP
```

To persist iptables rules across reboots:

```
DEBIAN_FRONTEND=noninteractive apt install -q -y netfilter-persistent iptables-persistent service netfilter-persistent save
```

---
### Result

Due to a known OpenSSH bug, SSH may still use 2048-bit DH moduli in limited cases, meaning a maximum achievable score is 95%:

[https://bugzilla.mindrot.org/show_bug.cgi?id=2793](https://bugzilla.mindrot.org/show_bug.cgi?id=2793)

Despite this limitation, the server now successfully passes the ssh-audit hardening policy.